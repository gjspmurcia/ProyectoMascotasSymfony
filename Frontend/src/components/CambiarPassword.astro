---
import Modal from './Modal.astro';
const { usuarioId } = Astro.props;
const PUBLIC_API_URL = import.meta.env.PUBLIC_API_URL;
---

<div class="min-h-3/5 flex items-center p-12 bg-gradient-to-br from-[#ac63d377] to-[#e5d04bad] via-[#6cb4d177] via-at-29% via-[#71e8a376] via-at-68%">
  <div class="w-full max-w-3xl mx-auto">
    <h1 class="text-3xl text-center font-extrabold text-primary sm:text-4xl sm:tracking-tight mb-2">Cambia tu contraseña</h1>

    <form id="formCambioPassword" class="bg-white flex flex-col gap-4 w-full mx-auto p-8 rounded-xl shadow-xl hover:shadow-lg/40 border border-gray-300">
      <div class="mb-2">
        <label for="password">Contraseña:
          <span id="mensaje_password" class="text-gray-400">
            Debe contener al menos 8 caracteres, un número y una mayúscula
          </span>
        </label>
        <input type="password" id="password" name="password" required />
      </div>
      
      <div class="mb-4">
        <label for="password_confirm">Confirma la contraseña:</label>
        <input type="password" id="password_confirm" required />
      </div>

      <button type="submit">Cambiar</button>
      <a
        class="bg-amber-600 hover:bg-amber-800 text-white text-center font-bold py-2 px-6 rounded focus:outline-none focus:shadow-outline"
        href="javascript:history.back()">Volver</a>
      <p id="mensaje"></p>
    </form>
  </div>
</div>

<Modal title='Aviso:' />
<script define:vars={{ usuarioId, PUBLIC_API_URL }}>
  const formulario = document.getElementById("formCambioPassword");
  const mensaje = document.getElementById("mensaje");
  // const usuarioId = document.getElementById("usuarioId").value;

  formulario.addEventListener("submit", async (event) => {
    event.preventDefault();

    const password = formulario.password.value;
    const passwordConfirm = formulario.password_confirm.value;

    // Verificar que las contraseñas coincidan
    if (password !== passwordConfirm) {
      mensaje.textContent = "Las contraseñas no coinciden.";
      mensaje.style.color = "red";
      return;
    }

    try {
      const response = await fetch(`${PUBLIC_API_URL}/api/modificar_password/${usuarioId}`, {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json",
          Accept: "application/json",
        },
        body: JSON.stringify({ password }),
      });

      const result = await response.json();

      if (response.ok) {
        mensaje.textContent = "Editado con éxito";
        mensaje.classList.remove("text-red-500");
        mensaje.classList.add("text-green-500");
        window.showModal({
            message: "Contraseña cambiada correctamente.",
            onConfirm: () => {
              window.location.href = "/mi-perfil";
            }
          });
      } else {
          if (result.errores && Array.isArray(result.errores)) {
            const erroresTexto = result.errores
              .map((e) => `${e.campo}: ${e.error}`)
              .join("\n");
            mensaje.textContent = `Error: ${erroresTexto}`;
          } else {
            mensaje.textContent = `Error: ${result.mensaje || "Error desconocido"}`;
          }
          mensaje.classList.add("text-red-500");
        }
    } catch (error) {
      mensaje.textContent = "Error de red. Inténtalo de nuevo más tarde.";
      mensaje.style.color = "red";
    }
  });
</script>
